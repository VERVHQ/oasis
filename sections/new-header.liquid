{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top }}px;
    padding-bottom: {{ section.settings.padding_bottom }}px;
  }

  .new-header {
    background-color: {{ section.settings.bg_color }};
    color: {{ section.settings.text_color }};
    width: 100%;
    position: relative;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    z-index: 100;
  }

  .new-header.sticky {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    transition: transform 0.3s ease-in-out;
    will-change: transform;
  }

  /* Scroll Down - Hide */
  .new-header.sticky.scroll-down {
    transform: translate3d(0, -100%, 0);
  }

  /* Scroll Up - Show */
  .new-header.sticky.scroll-up {
    transform: translate3d(0, 0, 0);
  }

  .new-header__container {
    max-width: {{ section.settings.page_width }}px;
    margin: 0 auto;
    padding: 0 20px;
    height: 90px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  /* Logo */
  .new-header__logo {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    text-decoration: none;
    color: inherit;
  }

  .new-header__logo img {
    height: auto;
    display: block;
  }
  
  .new-header__logo-text {
    font-size: 24px;
    font-weight: 700;
    letter-spacing: -0.5px;
  }

  /* Navigation */
  .new-header__nav {
    display: none;
    height: 100%;
    align-items: center;
  }

  @media screen and (min-width: 990px) {
    .new-header__nav {
      display: flex;
    }
  }

  .new-header__menu {
    display: flex;
    gap: 32px;
    list-style: none;
    margin: 0;
    padding: 0;
    height: 100%;
  }

  .new-header__menu-item {
    height: 100%;
    display: flex;
    align-items: center;
    position: relative;
    cursor: pointer;
  }

  .new-header__link {
    color: {{ section.settings.text_color }};
    text-decoration: none;
    font-size: 16px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: 50px;
    transition: all 0.2s ease;
  }

  .new-header__link:hover,
  .new-header__link.active {
    color: {{ section.settings.accent_color }};
    background-color: {{ section.settings.hover_bg_color }};
  }

  .new-header__chevron {
    width: 10px;
    height: 10px;
    transition: transform 0.2s ease;
  }

  .new-header__menu-item:hover .new-header__chevron {
    transform: rotate(180deg);
  }

  /* Mega Menu */
  .new-header__mega-menu {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(10px);
    width: max-content;
    max-width: 90vw;
    background: #ffffff;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    border-radius: 16px;
    padding: 40px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 60px;
    z-index: 101;
    border: 1px solid rgba(0,0,0,0.05);
  }

  .new-header__mega-menu::before {
    content: '';
    position: absolute;
    top: -20px;
    left: 0;
    width: 100%;
    height: 20px;
    background: transparent;
  }

  .new-header__menu-item:hover .new-header__mega-menu {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
  }

  .new-header__column-title {
    font-size: 14px;
    font-weight: 600;
    color: #9CA3AF; /* Gray-400 */
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 24px;
    display: block;
  }

  .new-header__sub-menu {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .new-header__sub-link {
    display: flex;
    align-items: flex-start; /* Align icon with top of text */
    gap: 12px;
    text-decoration: none;
    color: {{ section.settings.text_color }};
    font-weight: 600;
    font-size: 16px;
    transition: color 0.1s ease;
  }

  .new-header__sub-link:hover {
    color: {{ section.settings.accent_color }};
  }

  .new-header__icon-wrapper {
    width: 24px;
    height: 24px;
    flex-shrink: 0;
    color: inherit;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .new-header__icon-wrapper svg {
    width: 100%;
    height: 100%;
    stroke-width: 1.5;
  }

  /* Actions removed */
  .new-header__actions {
    display: none; 
  }

  /* Cart Icon */
  .new-header__cart-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    color: inherit;
    text-decoration: none;
    position: relative;
    width: 44px;
    height: 44px;
    margin-right: -5px; 
  }
  
  /* Right side wrapper to keep Cart and Mobile Toggle together */
  .new-header__right {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .new-header__cart-icon svg {
    width: 24px;
    height: 24px;
    stroke-width: 2px; /* Make it bold as per brand */
    stroke: currentColor;
    fill: none;
  }
  
  .cart-count-bubble {
    position: absolute;
    background-color: {{ section.settings.accent_color }};
    color: #fff;
    height: 1.7rem;
    width: 1.7rem;
    border-radius: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 0.9rem;
    bottom: 0.4rem;
    left: 2.2rem;
    line-height: normal;
  }

  /* Mobile Toggle */
  .new-header__mobile-toggle {
    display: block;
    background: none;
    border: none;
    cursor: pointer;
    padding: 6px;
    color: inherit;
  }

  @media screen and (min-width: 990px) {
    .new-header__mobile-toggle {
      display: none;
    }
  }

  /* Mobile Drawer */
  .mobile-drawer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
    visibility: hidden;
    pointer-events: none;
    transition: visibility 0.4s;
  }

  .mobile-drawer.is-open {
    visibility: visible;
    pointer-events: auto;
  }

  .mobile-drawer__overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(4px);
    opacity: 0;
    transition: opacity 0.4s ease;
  }

  .mobile-drawer.is-open .mobile-drawer__overlay {
    opacity: 1;
  }

  .mobile-drawer__content {
    position: absolute;
    top: 0;
    right: -100%;
    width: 85%;
    max-width: 400px;
    height: 100%;
    background: {{ section.settings.bg_color }};
    box-shadow: -10px 0 30px rgba(0,0,0,0.1);
    transition: right 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
    display: flex;
    flex-direction: column;
    padding: 30px;
    overflow-y: auto;
  }

  .mobile-drawer.is-open .mobile-drawer__content {
    right: 0;
  }

  .mobile-drawer__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 40px;
  }

  .mobile-drawer__close {
    background: none;
    border: none;
    padding: 8px;
    cursor: pointer;
    color: {{ section.settings.text_color }};
  }

  .mobile-menu {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .mobile-menu__item {
    border-bottom: 1px solid rgba(0,0,0,0.05);
    padding-bottom: 12px;
  }

  .mobile-menu__link {
    font-size: 20px;
    font-weight: 700;
    color: {{ section.settings.text_color }};
    text-decoration: none;
    display: block;
    padding: 10px 0;
    font-family: 'Quicksand', sans-serif;
  }

  .mobile-submenu {
    list-style: none;
    padding-left: 20px;
    margin-top: 10px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .mobile-submenu__link {
    font-size: 16px;
    font-weight: 500;
    color: {{ section.settings.text_color }};
    text-decoration: none;
    opacity: 0.8;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .mobile-submenu__icon {
    width: 18px;
    height: 18px;
    opacity: 0.7;
  }
  
  body.menu-open {
    overflow: hidden;
  }

{%- endstyle -%}

<!-- Spacer for fixed header -->
<div class="header-spacer"></div>

<header class="new-header section-{{ section.id }}-padding {% if section.settings.enable_sticky %}sticky{% endif %}">
  <div class="new-header__container">
    <!-- Logo -->
    <a href="{{ routes.root_url }}" class="new-header__logo">
      {%- if section.settings.logo != blank -%}
        {{ section.settings.logo | image_url: width: section.settings.logo_width | image_tag: loading: 'eager', alt: shop.name }}
      {%- else -%}
        <span class="new-header__logo-text">{{ shop.name }}</span>
      {%- endif -%}
    </a>

    <!-- Desktop Nav -->
    <nav class="new-header__nav">
      <ul class="new-header__menu">
        {%- for link in section.settings.menu.links -%}
          <li class="new-header__menu-item">
            <a href="{{ link.url }}" class="new-header__link {% if link.active or link.child_active %}active{% endif %}">
              {{ link.title }}
              {%- if link.links != blank -%}
                <svg class="new-header__chevron" viewBox="0 0 10 6" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M1 1L5 5L9 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              {%- endif -%}
            </a>

            {%- if link.links != blank -%}
              <div class="new-header__mega-menu">
                {%- for child_link in link.links -%}
                  <div class="new-header__column">
                    <span class="new-header__column-title">{{ child_link.title }}</span>
                    <ul class="new-header__sub-menu">
                      {%- for grandchild_link in child_link.links -%}
                        <li>
                          <a href="{{ grandchild_link.url }}" class="new-header__sub-link">
                            {%- assign icon_svg = '' -%}
                            {%- for block in section.blocks -%}
                              {%- if block.settings.menu_title == grandchild_link.title -%}
                                {%- assign icon_svg = block.settings.svg_code -%}
                                {%- break -%}
                              {%- endif -%}
                            {%- endfor -%}

                            {%- if icon_svg != blank -%}
                              <div class="new-header__icon-wrapper">
                                {{ icon_svg }}
                              </div>
                            {%- endif -%}
                            
                            {{ grandchild_link.title }}
                          </a>
                        </li>
                      {%- endfor -%}
                    </ul>
                  </div>
                {%- endfor -%}
              </div>
            {%- endif -%}
          </li>
        {%- endfor -%}
      </ul>
    </nav>



    <!-- Mobile Toggle -->
    <button class="new-header__mobile-toggle" aria-label="Open Menu" id="MobileToggle">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    <!-- Right Side Actions (Cart + Mobile Toggle) -->
    <div class="new-header__right">
      
      <!-- Cart Icon -->
      <a href="{{ routes.cart_url }}" class="new-header__cart-icon link focus-inset" id="cart-icon-bubble">
        <!-- Shopping Bag Icon -->
        <svg class="icon icon-cart" aria-hidden="true" focusable="false" role="presentation" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <path d="M16 10a4 4 0 0 1-8 0"></path>
        </svg>
        <span class="visually-hidden">{{ 'templates.cart.cart' | t }}</span>
        {%- if cart != empty -%}
          <div class="cart-count-bubble">
            {%- if cart.item_count < 100 -%}
              <span aria-hidden="true">{{ cart.item_count }}</span>
            {%- endif -%}
            <span class="visually-hidden">{{ 'sections.header.cart_count' | t: count: cart.item_count }}</span>
          </div>
        {%- endif -%}
      </a>

      <!-- Mobile Toggle -->
      <button class="new-header__mobile-toggle" aria-label="Open Menu" id="MobileToggle">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>
</header>

<!-- Mobile Drawer HTML -->
<div class="mobile-drawer" id="MobileDrawer">
  <div class="mobile-drawer__overlay" id="DrawerOverlay"></div>
  <div class="mobile-drawer__content">
    <div class="mobile-drawer__header">
      <span class="new-header__logo-text">{{ shop.name }}</span>
      <button class="mobile-drawer__close" id="DrawerClose" aria-label="Close Menu">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <nav class="mobile-drawer__nav">
      <ul class="mobile-menu">
        {%- for link in section.settings.menu.links -%}
          <li class="mobile-menu__item">
            <a href="{{ link.url }}" class="mobile-menu__link">{{ link.title }}</a>
            {%- if link.links != blank -%}
              <ul class="mobile-submenu">
                {%- for child_link in link.links -%}
                  {%- for grandchild_link in child_link.links -%}
                    <li>
                       <a href="{{ grandchild_link.url }}" class="mobile-submenu__link">
                         {%- assign icon_svg = '' -%}
                         {%- for block in section.blocks -%}
                           {%- if block.settings.menu_title == grandchild_link.title -%}
                             {%- assign icon_svg = block.settings.svg_code -%}
                             {%- break -%}
                           {%- endif -%}
                         {%- endfor -%}
                         
                         {%- if icon_svg != blank -%}
                           <div class="mobile-submenu__icon">{{ icon_svg }}</div>
                         {%- endif -%}
                         {{ grandchild_link.title }}
                       </a>
                    </li>
                  {%- endfor -%}
                {%- endfor -%}
              </ul>
            {%- endif -%}
          </li>
        {%- endfor -%}
      </ul>
    </nav>
  </div>
</div>

{%- if settings.cart_type == "notification" -%}
  {%- render 'cart-notification', color_scheme: section.settings.color_scheme, desktop_menu_type: section.settings.menu_type_desktop -%}
{%- endif -%}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const header = document.querySelector('header.new-header.sticky');
    
    // Handle Spacer if header is sticky
    if (header) {
      const spacer = document.querySelector('.header-spacer');
      if (spacer) {
        const updateSpacer = () => {
           const height = header.offsetHeight || 90;
           spacer.style.height = height + 'px';
           spacer.style.width = '100%';
           spacer.style.display = 'block';
        };
        updateSpacer();
        window.addEventListener('resize', updateSpacer);
        window.addEventListener('load', updateSpacer);
      }
    }
    
    if (!header) return;

    let lastScroll = 0;
    const scrollThreshold = 60; // Minimum scroll before action

    window.addEventListener('scroll', function() {
      const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
      
      // Don't hide if menu is open
      if (document.body.classList.contains('menu-open')) return;

      // Ignore bounce (negative scroll)
      if (currentScroll <= 0) {
        header.classList.remove('scroll-down');
        header.classList.add('scroll-up'); // Ensure visible at top
        return;
      }
      
      // Check difference to avoid jitter
      if (Math.abs(currentScroll - lastScroll) < 10) return;

      if (currentScroll > lastScroll && currentScroll > scrollThreshold) {
        // Scrolling Down AND passed threshold -> Hide
        header.classList.remove('scroll-up');
        header.classList.add('scroll-down');
      } else if (currentScroll < lastScroll) {
        // Scrolling Up -> Show
        header.classList.remove('scroll-down');
        header.classList.add('scroll-up');
      }
      
      lastScroll = currentScroll;
    }, { passive: true });

    // --- Mobile Drawer Logic ---
    const drawer = document.getElementById('MobileDrawer');
    const toggle = document.getElementById('MobileToggle');
    const close = document.getElementById('DrawerClose');
    const overlay = document.getElementById('DrawerOverlay');

    const openDrawer = () => {
      drawer.classList.add('is-open');
      document.body.classList.add('menu-open');
    };

    const closeDrawer = () => {
      drawer.classList.remove('is-open');
      document.body.classList.remove('menu-open');
    };

    if (toggle) toggle.addEventListener('click', openDrawer);
    if (close) close.addEventListener('click', closeDrawer);
    if (overlay) overlay.addEventListener('click', closeDrawer);

  });
</script>

{% schema %}
{
  "name": "Smart Sticky Header",
  "tag": "section",
  "class": "section-header",
  "settings": [
    {
      "type": "header",
      "content": "Structure"
    },
    {
      "type": "checkbox",
      "id": "enable_sticky",
      "label": "Enable Sticky Header",
      "default": true
    },
    {
      "type": "range",
      "id": "page_width",
      "min": 1000,
      "max": 1600,
      "step": 40,
      "unit": "px",
      "label": "Content Width",
      "default": 1400
    },
    {
      "type": "header",
      "content": "Logo"
    },
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo Image"
    },
    {
      "type": "range",
      "id": "logo_width",
      "min": 50,
      "max": 300,
      "step": 10,
      "unit": "px",
      "label": "Logo Width",
      "default": 120
    },
    {
      "type": "header",
      "content": "Navigation"
    },
    {
      "type": "link_list",
      "id": "menu",
      "label": "Main Menu",
      "default": "main-menu"
    },
    {
      "type": "header",
      "content": "Right Side Actions"
    },
    {
      "type": "text",
      "id": "link_1_text",
      "label": "Link 1 Text",
      "default": "Log In"
    },
    {
      "type": "url",
      "id": "link_1_url",
      "label": "Link 1 URL"
    },
    {
      "type": "text",
      "id": "link_2_text",
      "label": "Link 2 Text",
      "default": "Sign Up"
    },
    {
      "type": "url",
      "id": "link_2_url",
      "label": "Link 2 URL"
    },
    {
      "type": "text",
      "id": "cta_text",
      "label": "CTA Button Text",
      "default": "Book a Demo"
    },
    {
      "type": "url",
      "id": "cta_url",
      "label": "CTA Button URL"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Accent Color (Hover Text)",
      "default": "#272727"
    },
    {
      "type": "color",
      "id": "hover_bg_color",
      "label": "Hover Background Color",
      "default": "#f3f4f6"
    },
    {
      "type": "color",
      "id": "cta_bg_color",
      "label": "CTA Background Color",
      "default": "#272727"
    },
    {
      "type": "color",
      "id": "cta_text_color",
      "label": "CTA Text Color",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 60,
      "step": 4,
      "unit": "px",
      "label": "Padding Top",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 60,
      "step": 4,
      "unit": "px",
      "label": "Padding Bottom",
      "default": 0
    }
  ],
  "blocks": [
    {
      "type": "icon_mapping",
      "name": "Icon for Menu Item",
      "settings": [
        {
          "type": "text",
          "id": "menu_title",
          "label": "Menu Item Title",
          "info": "Exact title of the menu item to apply this icon to."
        },
        {
          "type": "html",
          "id": "svg_code",
          "label": "SVG Code",
          "info": "Paste SVG code here."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Smart Sticky Header",
      "settings": {
        "menu": "main-menu"
      }
    }
  ]
}
{% endschema %}
